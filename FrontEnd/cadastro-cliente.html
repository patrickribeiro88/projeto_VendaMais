<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Cliente - Venda+</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="dashboard-wrapper">
        <div class="sidebar bg-dark" id="sidebar-wrapper">
            <div class="sidebar-heading text-center py-4">
                <a href="dashboard.html" class="text-decoration-none">
                    <h1 class="logo-sidebar logo-full">VENDA<i>+</i></h1>
                    <h1 class="logo-sidebar logo-compact">V<i>+</i></h1>
                </a>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link" href="dashboard.html"><i class="fas fa-chart-line"></i><span class="sidebar-text">Relatório de Vendas</span></a></li>
                <li class="nav-item"><a class="nav-link" href="registro-vendas.html"><i class="fas fa-cash-register"></i><span class="sidebar-text">Registro de Vendas</span></a></li>
                <li class="nav-item"><a class="nav-link active" href="cadastro-cliente.html"><i class="fas fa-user-plus"></i><span class="sidebar-text">Cadastro Clientes</span></a></li>
                <li class="nav-item"><a class="nav-link" href="cadastro-produto.html"><i class="fas fa-box-open"></i><span class="sidebar-text">Cadastro Produto</span></a></li>
                <li class="nav-item"><a class="nav-link" href="consulta.html"><i class="fas fa-search"></i><span class="sidebar-text">Consulta</span></a></li>
                <li class="nav-item"><a class="nav-link" href="inativos.html"><i class="fas fa-user-slash"></i><span class="sidebar-text">Inativos</span></a></li>
            </ul>
        </div>
        <div id="page-content-wrapper">
            <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
                <div class="container-fluid">
                    <button class="btn btn-primary" id="menu-toggle"><i class="fas fa-bars"></i></button>
                    <div class="collapse navbar-collapse">
                        <ul class="navbar-nav ms-auto mt-2 mt-lg-0">
                            <li class="nav-item">
                                <a class="nav-link position-relative" href="inativos.html" title="Ver inativos">
                                    <i class="fas fa-bell"></i>
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">2<span class="visually-hidden">notificações não lidas</span></span>
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-user-circle me-2"></i>Usuário Admin</a>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                                    <li><a class="dropdown-item" href="index.html">Sair</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
            <main class="container-fluid p-4">
                <h1 class="h3 mb-4">Formulário de Cadastro</h1>

                <div class="card shadow-sm border-0">
                    <div class="card-body p-4">
                        <div id="feedbackMessage" class="mb-3"></div>
                        
                        <form id="clienteForm" novalidate>
                            <div class="accordion custom-accordion" id="accordionCadastro">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePersonal" aria-expanded="true">
                                            <i class="fas fa-user me-2"></i> Dados Pessoais
                                        </button>
                                    </h2>
                                    <div id="collapsePersonal" class="accordion-collapse collapse show" data-bs-parent="#accordionCadastro">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label for="clienteNome" class="form-label">Nome Completo</label>
                                                    <input type="text" class="form-control" id="clienteNome" placeholder="Digite o nome completo" required>
                                                    <div class="invalid-feedback">Nome é obrigatório.</div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="clienteCpf" class="form-label">CPF</label>
                                                    <input type="text" class="form-control" id="clienteCpf" placeholder="000.000.000-00" required>
                                                    <div class="invalid-feedback">CPF é obrigatório e deve conter 11 números.</div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="clienteNascimento" class="form-label">Data de Nascimento</label>
                                                    <input type="date" class="form-control" id="clienteNascimento" required>
                                                    <div class="invalid-feedback">Data de Nascimento é obrigatória.</div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="clienteGenero" class="form-label">Sexo</label>
                                                    <select id="clienteGenero" class="form-select" required>
                                                        <option value="" selected>Escolher...</option>
                                                        <option>Feminino</option>
                                                        <option>Masculino</option>
                                                    </select>
                                                    <div class="invalid-feedback">Selecione uma opção.</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAddress">
                                            <i class="fas fa-map-marker-alt me-2"></i> Residência
                                        </button>
                                    </h2>
                                    <div id="collapseAddress" class="accordion-collapse collapse" data-bs-parent="#accordionCadastro">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <div class="col-md-3">
                                                    <label for="clienteCep" class="form-label">CEP</label>
                                                    <input type="text" class="form-control" id="clienteCep" placeholder="00000-000" required>
                                                    <div class="invalid-feedback">CEP é obrigatório e deve conter 8 números.</div>
                                                </div>
                                                <div class="col-md-7"><label for="clienteEndereco" class="form-label">Endereço</label><input type="text" class="form-control" id="clienteEndereco" placeholder="Rua, Avenida..." required><div class="invalid-feedback">Endereço é obrigatório.</div></div>
                                                <div class="col-md-2"><label for="clienteNumero" class="form-label">Número</label><input type="text" class="form-control" id="clienteNumero" placeholder="Ex: 123" required><div class="invalid-feedback">Número é obrigatório.</div></div>
                                                <div class="col-md-5"><label for="clienteBairro" class="form-label">Bairro</label><input type="text" class="form-control" id="clienteBairro" placeholder="Digite o bairro" required><div class="invalid-feedback">Bairro é obrigatório.</div></div>
                                                <div class="col-md-4"><label for="clienteCidade" class="form-label">Cidade</label><input type="text" class="form-control" id="clienteCidade" placeholder="Digite a cidade" required><div class="invalid-feedback">Cidade é obrigatória.</div></div>
                                                <div class="col-md-3"><label for="clienteEstado" class="form-label">Estado</label><input type="text" class="form-control" id="clienteEstado" placeholder="Ex: SC" required><div class="invalid-feedback">Estado é obrigatório.</div></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseContact">
                                            <i class="fas fa-phone me-2"></i> Telefone e E-mail
                                        </button>
                                    </h2>
                                    <div id="collapseContact" class="accordion-collapse collapse" data-bs-parent="#accordionCadastro">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <div class="col-md-4">
                                                    <label for="clienteTelefone1" class="form-label">Telefone 1</label>
                                                    <input type="tel" class="form-control" id="clienteTelefone1" placeholder="(00) 00000-0000" required>
                                                    <div class="invalid-feedback">Telefone é obrigatório e deve conter 10 ou 11 números.</div>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="clienteTelefone2" class="form-label">Telefone 2</label>
                                                    <input type="tel" class="form-control" id="clienteTelefone2" placeholder="(Opcional)">
                                                    <div class="invalid-feedback">Se preenchido, deve conter 10 ou 11 números.</div>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="clienteEmail" class="form-label">E-mail</label>
                                                    <input type="email" class="form-control" id="clienteEmail" placeholder="exemplo@email.com" required>
                                                    <div class="invalid-feedback">E-mail é obrigatório e deve ser válido.</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseObs">
                                            <i class="fas fa-comment-alt me-2"></i> Observação
                                        </button>
                                    </h2>
                                    <div id="collapseObs" class="accordion-collapse collapse" data-bs-parent="#accordionCadastro">
                                        <div class="accordion-body"><textarea class="form-control" id="clienteObservacao" rows="3" placeholder="Adicione notas sobre o cliente aqui..."></textarea></div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end mt-4">
                                <button type="submit" id="submitBtn" class="btn btn-primary px-4 btn-lg">Cadastrar Cliente</button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="card shadow-sm border-0 mt-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-dark">Lista de Clientes</h6>
                        <div class="input-group" style="max-width: 300px;"><input type="text" class="form-control" placeholder="Pesquisar clientes..."><button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button></div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table client-list-table">
                                <thead><tr><th>ID</th><th>Nome</th><th>Data de Nascimento</th><th>Telefone</th><th>E-mail</th><th class="text-center">Ações</th></tr></thead>
                                <tbody id="listaClientesBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white d-flex justify-content-end">
                        <nav aria-label="Navegação da lista de clientes">
                            <ul class="pagination mb-0">
                                <li class="page-item"><a class="page-link" href="#">Anterior</a></li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">Próximo</a></li>
                            </ul>
                        </nav>
                    </div>
                </div>
                </main>
            </div>
        </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- SCRIPT PARA CONTROLE DO MENU LATERAL (SIDEBAR) ---
        const menuToggle = document.getElementById('menu-toggle');
        const wrapper = document.getElementById('dashboard-wrapper');
        if (menuToggle) {
            menuToggle.addEventListener('click', function() {
                wrapper.classList.toggle('collapsed');
            });
        }

        // --- FUNÇÃO PARA CARREGAR A LISTA DE CLIENTES DO BACK-END ---
        async function carregarClientes() {
            const listaClientesBody = document.getElementById('listaClientesBody');
            listaClientesBody.innerHTML = '';
            try {
                const response = await fetch('http://localhost:3000/api/clientes');
                const clientes = await response.json();
                if (clientes.length === 0) {
                    listaClientesBody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum cliente cadastrado.</td></tr>';
                    return;
                }
                clientes.forEach(cliente => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${cliente.idCliente}</td>
                        <td>${cliente.nome}</td>
                        <td>${cliente.dataNascimento || ''}</td>
                        <td>${cliente.telefone1 || ''}</td>
                        <td>${cliente.email || ''}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-primary" title="Editar"><i class="fas fa-pencil-alt"></i></button>
                            <button class="btn btn-sm btn-outline-danger" title="Inativar Cliente"><i class="fas fa-user-slash"></i></button>
                        </td>
                    `;
                    listaClientesBody.appendChild(tr);
                });
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                listaClientesBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar a lista de clientes.</td></tr>';
            }
        }

        // --- SCRIPT DE VALIDAÇÃO E ENVIO DO FORMULÁRIO DE CADASTRO ---
        document.addEventListener('DOMContentLoaded', function() {
            // Seleciona os elementos do formulário que precisam de validação
            const clienteForm = document.getElementById('clienteForm');
            const feedbackMessage = document.getElementById('feedbackMessage');
            const submitBtn = document.getElementById('submitBtn');
            
            // Mapeia todos os campos com suas respectivas regras de validação
            const inputsToValidate = [
                { id: 'clienteNome', validation: val => val.trim() !== '', required: true },
                { id: 'clienteNascimento', validation: val => val !== '', required: true },
                { id: 'clienteCpf', validation: val => val.length === 11, numeric: true, required: true },
                { id: 'clienteGenero', validation: val => val !== '', required: true },
                { id: 'clienteCep', validation: val => val.length === 8, numeric: true, required: true },
                { id: 'clienteEndereco', validation: val => val.trim() !== '', required: true },
                { id: 'clienteNumero', validation: val => val.trim() !== '', required: true },
                { id: 'clienteBairro', validation: val => val.trim() !== '', required: true },
                { id: 'clienteCidade', validation: val => val.trim() !== '', required: true },
                { id: 'clienteEstado', validation: val => val.trim() !== '', required: true },
                { id: 'clienteTelefone1', validation: val => val.length >= 10 && val.length <= 11, numeric: true, required: true },
                { id: 'clienteTelefone2', validation: val => val.length === 0 || (val.length >= 10 && val.length <= 11), numeric: true, required: false },
                { id: 'clienteEmail', validation: val => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val), required: true }
            ];

            // Função que força um campo a aceitar apenas números (remove letras e caracteres especiais)
            function forceNumeric(input) {
                input.addEventListener('input', () => {
                    input.value = input.value.replace(/\D/g, '');
                });
            }

            // Função para validar um campo e mostrar feedback visual (borda verde/vermelha)
            function validateField(input, validationFn, isRequired) {
                // Se o campo não for obrigatório e estiver vazio, ele é considerado neutro (nem válido, nem inválido)
                if (!isRequired && input.value.trim() === '') {
                    input.classList.remove('is-valid', 'is-invalid');
                    return true;
                }
                const isValid = validationFn(input.value);
                input.classList.toggle('is-valid', isValid);
                input.classList.toggle('is-invalid', !isValid);
                return isValid;
            }
            
            // Função para verificar se o formulário inteiro está válido e habilitar/desabilitar o botão de cadastro
            function checkFormValidity() {
                let isFormValid = true;
                inputsToValidate.forEach(item => {
                    const input = document.getElementById(item.id);
                    // Um campo é inválido se a validação de formato falhar OU se for obrigatório e estiver vazio
                    if (!item.validation(input.value) && item.required) {
                        isFormValid = false;
                    }
                    if (!item.validation(input.value) && !item.required && input.value.trim() !== '') {
                        isFormValid = false;
                    }
                });
                submitBtn.disabled = !isFormValid;
            }
            
            // Adiciona "ouvintes" de validação para cada campo do formulário
            inputsToValidate.forEach(item => {
                const input = document.getElementById(item.id);
                if (input) {
                    if (item.numeric) { forceNumeric(input); }
                    // Valida em tempo real a cada digitação para habilitar/desabilitar o botão
                    input.addEventListener('input', checkFormValidity);
                    // Mostra o feedback visual (verde/vermelho) quando o usuário sai do campo
                    input.addEventListener('blur', () => {
                        validateField(input, item.validation, item.required);
                    });
                }
            });
            
            // Roda a validação uma vez ao carregar a página para definir o estado inicial do botão (desabilitado)
            checkFormValidity();

            // SCRIPT PARA ENVIAR O FORMULÁRIO DE CADASTRO AO BACK-END
            clienteForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                // A validação final já é feita pelo 'checkFormValidity' que desabilita o botão
                
                feedbackMessage.innerHTML = '';
                const dados = {
                    nome: document.getElementById('clienteNome').value,
                    cpf: document.getElementById('clienteCpf').value,
                    dataNascimento: document.getElementById('clienteNascimento').value,
                    genero: document.getElementById('clienteGenero').value,
                    cep: document.getElementById('clienteCep').value,
                    endereco: document.getElementById('clienteEndereco').value,
                    numero: document.getElementById('clienteNumero').value,
                    bairro: document.getElementById('clienteBairro').value,
                    cidade: document.getElementById('clienteCidade').value,
                    estado: document.getElementById('clienteEstado').value,
                    telefone1: document.getElementById('clienteTelefone1').value,
                    telefone2: document.getElementById('clienteTelefone2').value,
                    email: document.getElementById('clienteEmail').value,
                    observacao: document.getElementById('clienteObservacao').value
                };
                
                try {
                    const response = await fetch('http://localhost:3000/api/clientes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                    const result = await response.json();
                    if (response.ok) {
                        feedbackMessage.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                        clienteForm.reset();
                        document.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
                            el.classList.remove('is-valid', 'is-invalid');
                        });
                        setTimeout(() => {
                            feedbackMessage.innerHTML = '';
                        }, 5000);
                        
                        checkFormValidity();
                        carregarClientes(); 
                    } else {
                        feedbackMessage.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
                    }
                } catch (error) {
                    feedbackMessage.innerHTML = `<div class="alert alert-danger">Não foi possível conectar ao servidor.</div>`;
                }
            });
        });

        // INICIA A PÁGINA CARREGANDO A LISTA DE CLIENTES
        document.addEventListener('DOMContentLoaded', carregarClientes);
    </script>
</body>
</html>