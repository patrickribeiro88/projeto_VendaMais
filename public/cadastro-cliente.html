<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro de Cliente - Venda+</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />

</head>

<body>
  <div id="dashboard-wrapper">
    <div class="sidebar bg-dark" id="sidebar-wrapper">
      <div class="sidebar-heading text-center py-4">
        <a href="dashboard.html" class="text-decoration-none">
          <h1 class="logo-sidebar logo-full">VENDA<i>+</i></h1>
          <h1 class="logo-sidebar logo-compact">V<i>+</i></h1>
        </a>
      </div>
      <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link" href="dashboard.html"><i class="fas fa-chart-line"></i><span
              class="sidebar-text">Relatório de Vendas</span></a></li>
        <li class="nav-item"><a class="nav-link" href="registro-vendas.html"><i class="fas fa-cash-register"></i><span
              class="sidebar-text">Registro de Vendas</span></a></li>
        <li class="nav-item"><a class="nav-link active" href="cadastro-cliente.html"><i
              class="fas fa-user-plus"></i><span class="sidebar-text">Cadastro Clientes</span></a></li>
        <li class="nav-item"><a class="nav-link" href="cadastro-produto.html"><i class="fas fa-box-open"></i><span
              class="sidebar-text">Cadastro Produto</span></a></li>
        <li class="nav-item"><a class="nav-link" href="consulta.html"><i class="fas fa-search"></i><span
              class="sidebar-text">Consulta</span></a></li>
        <li class="nav-item"><a class="nav-link" href="inativos.html"><i class="fas fa-user-slash"></i><span
              class="sidebar-text">Inativos</span></a></li>
      </ul>
    </div>

    <div id="page-content-wrapper">
      <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
        <div class="container-fluid">
          <button class="btn btn-primary" id="menu-toggle"><i class="fas fa-bars"></i></button>
          <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto mt-2 mt-lg-0">
              <li class="nav-item">
                <a class="nav-link position-relative" href="inativos.html" title="Ver inativos">
                  <i class="fas fa-bell"></i>
                  <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                    2
                    <span class="visually-hidden">notificações não lidas</span>
                  </span>
                </a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown"
                  aria-expanded="false">
                  <i class="fas fa-user-circle me-2"></i>Usuário Admin
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                  <li><a class="dropdown-item" href="index.html">Sair</a></li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <main class="container-fluid p-4">

        <div class="card shadow-sm border-0">
          <div class="card-body p-4">
            <div id="feedbackMessage" class="mb-3"></div>
            <form id="clienteForm" novalidate>
              <div class="accordion custom-accordion" id="accordionCadastro">

                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse"
                      data-bs-target="#collapsePersonal" aria-expanded="true">
                      <i class="fas fa-user me-2"></i> Dados Pessoais
                    </button>
                  </h2>
                  <div id="collapsePersonal" class="accordion-collapse collapse show"
                    data-bs-parent="#accordionCadastro">
                    <div class="accordion-body">
                      <div class="row g-3">
                        <div class="col-md-6">
                          <label for="clienteNome" class="form-label">Nome Completo</label>
                          <input type="text" class="form-control" id="clienteNome" name="nome"
                            placeholder="Digite o nome completo" required>
                          <div class="invalid-feedback">Nome é obrigatório.</div>
                        </div>
                        <div class="col-md-6">
                          <label for="clienteCpf" class="form-label">CPF</label>
                          <input type="text" class="form-control" id="clienteCpf" name="cpf"
                            placeholder="Somente números" required>
                          <div class="invalid-feedback">CPF é obrigatório e deve conter 11 números.</div>
                        </div>
                        <div class="col-md-6">
                          <label for="clienteNascimento" class="form-label">Data de Nascimento</label>
                          <input type="date" class="form-control" id="clienteNascimento" name="dataNascimento" required>
                          <div class="invalid-feedback">Data de Nascimento é obrigatória.</div>
                        </div>
                        <div class="col-md-6">
                          <label for="clienteGenero" class="form-label">Sexo</label>
                          <select id="clienteGenero" name="genero" class="form-select" required>
                            <option value="">Escolher...</option>
                            <option>Feminino</option>
                            <option>Masculino</option>
                          </select>
                          <div class="invalid-feedback">Selecione uma opção.</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                      data-bs-target="#collapseAddress">
                      <i class="fas fa-map-marker-alt me-2"></i> Residência
                    </button>
                  </h2>
                  <div id="collapseAddress" class="accordion-collapse collapse" data-bs-parent="#accordionCadastro">
                    <div class="accordion-body">
                      <div class="row g-3">
                        <div class="col-md-3">
                          <label for="clienteCep" class="form-label">CEP</label>
                          <input type="text" class="form-control" id="clienteCep" name="cep"
                            placeholder="Somente números" required>
                          <div class="invalid-feedback">CEP é obrigatório e deve conter 8 números.</div>
                        </div>
                        <div class="col-md-7">
                          <label for="clienteEndereco" class="form-label">Endereço</label>
                          <input type="text" class="form-control" id="clienteEndereco" name="endereco"
                            placeholder="Rua, Avenida..." required>
                          <div class="invalid-feedback">Endereço é obrigatório.</div>
                        </div>
                        <div class="col-md-2">
                          <label for="clienteNumero" class="form-label">Número</label>
                          <input type="text" class="form-control" id="clienteNumero" name="numero" placeholder="Ex: 123"
                            required>
                          <div class="invalid-feedback">Número é obrigatório.</div>
                        </div>
                        <div class="col-md-5">
                          <label for="clienteBairro" class="form-label">Bairro</label>
                          <input type="text" class="form-control" id="clienteBairro" name="bairro"
                            placeholder="Digite o bairro" required>
                          <div class="invalid-feedback">Bairro é obrigatório.</div>
                        </div>
                        <div class="col-md-4">
                          <label for="clienteCidade" class="form-label">Cidade</label>
                          <input type="text" class="form-control" id="clienteCidade" name="cidade"
                            placeholder="Digite a cidade" required>
                          <div class="invalid-feedback">Cidade é obrigatória.</div>
                        </div>
                        <div class="col-md-3">
                          <label for="clienteEstado" class="form-label">Estado</label>
                          <input type="text" class="form-control" id="clienteEstado" name="estado" placeholder="Ex: SC"
                            required>
                          <div class="invalid-feedback">Estado é obrigatório.</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                      data-bs-target="#collapseContact">
                      <i class="fas fa-phone me-2"></i> Telefone e E-mail
                    </button>
                  </h2>
                  <div id="collapseContact" class="accordion-collapse collapse" data-bs-parent="#accordionCadastro">
                    <div class="accordion-body">
                      <div class="row g-3">
                        <div class="col-md-4">
                          <label for="clienteTelefone1" class="form-label">Telefone 1</label>
                          <input type="text" class="form-control" id="clienteTelefone1" name="telefone1"
                            placeholder="Somente números" required>
                          <div class="invalid-feedback">Telefone é obrigatório e deve conter 10 ou 11 números.</div>
                        </div>
                        <div class="col-md-4">
                          <label for="clienteTelefone2" class="form-label">Telefone 2</label>
                          <input type="text" class="form-control" id="clienteTelefone2" name="telefone2"
                            placeholder="(Opcional)">
                          <div class="invalid-feedback">Se preenchido, deve conter 10 ou 11 números.</div>
                        </div>
                        <div class="col-md-4">
                          <label for="clienteEmail" class="form-label">E-mail</label>
                          <input type="email" class="form-control" id="clienteEmail" name="email"
                            placeholder="exemplo@email.com" required>
                          <div class="invalid-feedback">E-mail é obrigatório e deve ser válido.</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                      data-bs-target="#collapseObs">
                      <i class="fas fa-comment-alt me-2"></i> Observação
                    </button>
                  </h2>
                  <div id="collapseObs" class="accordion-collapse collapse" data-bs-parent="#accordionCadastro">
                    <div class="accordion-body">
                      <textarea class="form-control" id="clienteObservacao" name="observacao" rows="3"
                        placeholder="Adicione notas sobre o cliente aqui..."></textarea>
                    </div>
                  </div>
                </div>
              </div>

              <div class="d-flex gap-2 justify-content-end mt-4">
                <button type="button" id="cancelarBtn" class="btn btn-outline-secondary d-none">Cancelar
                  alterações</button>
                <button type="submit" id="submitBtn" class="btn btn-primary px-4 btn-lg">Cadastrar Cliente</button>
              </div>
            </form>
          </div>
        </div>

        <div class="card shadow-sm border-0 mt-4">
          <div class="card-header bg-white d-flex flex-wrap gap-2 justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-dark">Lista de Clientes</h6>
            <div class="input-group" style="max-width: 320px;">
              <input type="text" id="pesquisarInput" class="form-control" placeholder="Pesquisar clientes...">
              <button class="btn btn-outline-secondary" id="pesquisarBtn" type="button" title="Pesquisar">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>

          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover table-sm client-list-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Data de Nascimento</th>
                    <th>Telefone</th>
                    <th>E-mail</th>
                    <th class="text-center">Ações</th>
                  </tr>
                </thead>
                <tbody id="listaClientesBody"></tbody>
              </table>
            </div>
          </div>

          <div class="card-footer bg-white">
            <nav aria-label="Paginação">
              <ul class="pagination justify-content-end mb-0" id="paginacao"></ul>
            </nav>
          </div>
        </div>

        <!-- SCRIPT FINAL -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="frontend.js"></script>

        <script>

          /* ====== Sidebar toggle ====== */
          const wrapper = document.getElementById('dashboard-wrapper');
          document.getElementById('menu-toggle').addEventListener('click', () => wrapper.classList.toggle('collapsed'));

          /* ====== Estado global ====== */
          let todosClientes = [];       // lista completa vinda da API
          let filtrados = [];           // lista após filtro de pesquisa
          let clienteEditando = null;   // id em edição
          const pageSize = 10;          // 10 por página
          let currentPage = 1;

          /* ====== Util: mensagens ====== */
          const feedback = document.getElementById('feedbackMessage');
          function flash(msg, type = 'success', ms = 5000) {
            feedback.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
            setTimeout(() => feedback.innerHTML = '', ms);
          }

          /* ====== Validação amigável ====== */
          const camposRegras = {
            clienteNome: v => v.trim() !== '',
            clienteCpf: v => /^\d{11}$/.test(v),
            clienteNascimento: v => v.trim() !== '',
            clienteGenero: v => v.trim() !== '',
            clienteCep: v => /^\d{8}$/.test(v),
            clienteEndereco: v => v.trim() !== '',
            clienteNumero: v => v.trim() !== '',
            clienteBairro: v => v.trim() !== '',
            clienteCidade: v => v.trim() !== '',
            clienteEstado: v => v.trim() !== '',
            clienteTelefone1: v => /^\d{10,11}$/.test(v),
            clienteTelefone2: v => v.trim() === '' || /^\d{10,11}$/.test(v), // <-- validado só se tiver preenchido
            clienteEmail: v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v),
          };

          function validarCampos() {
            let ok = true;
            Object.entries(camposRegras).forEach(([id, fn]) => {
              const el = document.getElementById(id);
              const val = el.value || '';
              const pass = fn(val);
              el.classList.toggle('is-invalid', !pass);
              el.classList.toggle('is-valid', pass);
              if (!pass && el.hasAttribute('required')) ok = false;
            });
            const tel2 = document.getElementById('clienteTelefone2');
            if (tel2.value.trim() === '') {
              tel2.classList.remove('is-valid', 'is-invalid'); // Garante neutralidade se vazio
            }
            return ok;
          }

          /* ====== Força numérico onde precisa ====== */
          ['clienteCpf', 'clienteCep', 'clienteTelefone1', 'clienteTelefone2', 'clienteNumero']
            .forEach(id => {
              const el = document.getElementById(id);
              el.addEventListener('input', () => el.value = el.value.replace(/\D/g, ''));
            });

          /* ====== Inputs: valida ao sair do campo ====== */
          Object.keys(camposRegras).forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('blur', validarCampos);
          });

          /* ====== Carregar clientes ====== */
          async function fetchClientes() {
            const tbody = document.getElementById('listaClientesBody');
            tbody.innerHTML = '<tr><td colspan="6">Carregando...</td></tr>';
            try {
              const resp = await fetch('http://localhost:3000/api/clientes');
              const data = await resp.json();
              todosClientes = Array.isArray(data) ? data : [];
              aplicarFiltroEPaginar();  // prepara filtrados e monta tabela/paginação
            } catch {
              tbody.innerHTML = '<tr><td colspan="6" class="text-danger text-center">Erro ao carregar clientes.</td></tr>';
            }
          }

          /* ====== Filtro + Paginação ====== */
          function aplicarFiltroEPaginar() {
            const termo = (document.getElementById('pesquisarInput').value || '').toLowerCase().trim();

            filtrados = !termo ? [...todosClientes] :
              todosClientes.filter(c =>
                String(c.idCliente).includes(termo) ||
                (c.nome || '').toLowerCase().includes(termo) ||
                (c.email || '').toLowerCase().includes(termo) ||
                (c.telefone1 || '').includes(termo)
              );

            // ordena por id desc para mostrar “mais recentes”
            filtrados.sort((a, b) => Number(b.idCliente) - Number(a.idCliente));

            // reseta página se necessário
            const maxPage = Math.max(1, Math.ceil(filtrados.length / pageSize));
            if (currentPage > maxPage) currentPage = maxPage;

            renderTabelaPaginada();
            renderPaginacao();
          }

          function getPaginaAtual() {
            const start = (currentPage - 1) * pageSize;
            return filtrados.slice(start, start + pageSize);
          }

          /* ====== Render tabela ====== */
          function renderTabelaPaginada() {
            const tbody = document.getElementById('listaClientesBody');
            const page = getPaginaAtual();

            if (!page.length) {
              tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum cliente encontrado.</td></tr>';
              return;
            }

            tbody.innerHTML = '';
            page.forEach(c => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
      <td>${c.idCliente}</td>
      <td>${c.nome}</td>
      <td>${c.dataNascimento || ''}</td>
      <td>${c.telefone1 || ''}</td>
      <td>${c.email || ''}</td>
      <td class="text-center">
        <button class="btn btn-sm btn-outline-primary me-2" title="Editar" onclick="editarCliente(${c.idCliente})">
          <i class="fas fa-pencil-alt"></i>
        </button>
        <button class="btn btn-sm btn-outline-danger" title="Inativar" onclick="inativarCliente(${c.idCliente})">
          <i class="fas fa-user-slash"></i>
        </button>
      </td>
    `;
              tbody.appendChild(tr);
            });
          }

          /* ====== Render paginação ====== */
          function renderPaginacao() {
            const ul = document.getElementById('paginacao');
            ul.innerHTML = '';
            const total = filtrados.length;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));

            // Prev
            const prev = document.createElement('li');
            prev.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prev.innerHTML = `<a class="page-link" href="#">&laquo;</a>`;
            prev.onclick = (e) => { e.preventDefault(); if (currentPage > 1) { currentPage--; renderTabelaPaginada(); renderPaginacao(); } };
            ul.appendChild(prev);

            // Números (até 5 botões visíveis)
            const windowSize = 5;
            let start = Math.max(1, currentPage - Math.floor(windowSize / 2));
            let end = Math.min(totalPages, start + windowSize - 1);
            if (end - start + 1 < windowSize) start = Math.max(1, end - windowSize + 1);

            for (let p = start; p <= end; p++) {
              const li = document.createElement('li');
              li.className = `page-item ${p === currentPage ? 'active' : ''}`;
              li.innerHTML = `<a class="page-link" href="#">${p}</a>`;
              li.onclick = (e) => { e.preventDefault(); currentPage = p; renderTabelaPaginada(); renderPaginacao(); };
              ul.appendChild(li);
            }

            // Next
            const next = document.createElement('li');
            next.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            next.innerHTML = `<a class="page-link" href="#">&raquo;</a>`;
            next.onclick = (e) => { e.preventDefault(); if (currentPage < totalPages) { currentPage++; renderTabelaPaginada(); renderPaginacao(); } };
            ul.appendChild(next);
          }

          /* ====== Pesquisa ====== */
          document.getElementById('pesquisarInput').addEventListener('input', () => {
            currentPage = 1;
            aplicarFiltroEPaginar();
          });
          document.getElementById('pesquisarBtn').addEventListener('click', () => {
            currentPage = 1;
            aplicarFiltroEPaginar();
          });

          /* ====== Editar cliente ====== */
          async function editarCliente(id) {
            try {
              const resp = await fetch(`http://localhost:3000/api/clientes/${id}`);
              if (!resp.ok) return flash('Cliente não encontrado.', 'danger');
              const c = await resp.json();

              clienteEditando = id;
              // preenche
              clienteNome.value = c.nome || '';
              clienteCpf.value = c.cpf || '';
              clienteNascimento.value = (c.dataNascimento || '').split('T')[0] || '';
              clienteGenero.value = c.genero || '';
              clienteCep.value = c.cep || '';
              clienteEndereco.value = c.endereco || '';
              clienteNumero.value = c.numero || '';
              clienteBairro.value = c.bairro || '';
              clienteCidade.value = c.cidade || '';
              clienteEstado.value = c.estado || '';
              clienteTelefone1.value = c.telefone1 || '';
              clienteTelefone2.value = c.telefone2 || '';
              clienteEmail.value = c.email || '';
              clienteObservacao.value = c.observacao || '';

              // UI de edição
              document.getElementById('submitBtn').textContent = 'Salvar Alterações';
              document.getElementById('submitBtn').classList.replace('btn-primary', 'btn-warning');
              document.getElementById('cancelarBtn').classList.remove('d-none');

              // rola pro topo
              window.scrollTo({ top: 0, behavior: 'smooth' });

              // limpa estados de validação
              document.querySelectorAll('.is-valid, .is-invalid').forEach(el => el.classList.remove('is-valid', 'is-invalid'));
            } catch {
              flash('Erro ao carregar cliente.', 'danger');
            }
          }

          /* ====== Cancelar alterações ====== */
          document.getElementById('cancelarBtn').addEventListener('click', () => {
            clienteEditando = null;
            document.getElementById('clienteForm').reset();
            document.getElementById('submitBtn').textContent = 'Cadastrar Cliente';
            document.getElementById('submitBtn').classList.replace('btn-warning', 'btn-primary');
            document.getElementById('cancelarBtn').classList.add('d-none');
            document.querySelectorAll('.is-valid, .is-invalid').forEach(el => el.classList.remove('is-valid', 'is-invalid'));
          });

          /* ====== Cadastrar / Editar ====== */
          document.getElementById('clienteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!validarCampos()) {
              flash('Por favor, corrija os campos em vermelho.', 'danger');
              return;
            }

            const dados = Object.fromEntries(new FormData(e.target).entries());
            const url = clienteEditando ? `http://localhost:3000/api/clientes/${clienteEditando}` : 'http://localhost:3000/api/clientes';
            const method = clienteEditando ? 'PUT' : 'POST';

            try {
              const resp = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
              });
              const result = await resp.json();

              if (resp.ok) {
                flash(result.message || (clienteEditando ? 'Cliente atualizado com sucesso!' : 'Cliente cadastrado com sucesso!'));
                e.target.reset();
                clienteEditando = null;
                document.getElementById('submitBtn').textContent = 'Cadastrar Cliente';
                document.getElementById('submitBtn').classList.replace('btn-warning', 'btn-primary');
                document.getElementById('cancelarBtn').classList.add('d-none');
                document.querySelectorAll('.is-valid, .is-invalid').forEach(el => el.classList.remove('is-valid', 'is-invalid'));

                await fetchClientes();
              } else {
                flash(result.message || 'Erro ao salvar.', 'danger');
              }
            } catch {
              flash('Erro ao conectar com o servidor.', 'danger');
            }
          });

          /* ====== Inativar cliente ====== */
          async function inativarCliente(id) {
            if (!confirm('Deseja realmente inativar este cliente?')) return;
            try {
              const resp = await fetch(`http://localhost:3000/api/clientes/${id}/inativar`, { method: 'PATCH' });
              const result = await resp.json();
              if (resp.ok) {
                flash(result.message || 'Cliente inativado com sucesso!');
                await fetchClientes();
              } else {
                flash(result.message || 'Erro ao inativar.', 'danger');
              }
            } catch {
              flash('Erro ao inativar cliente.', 'danger');
            }
          }

          /* ====== Inicialização ====== */
          document.addEventListener('DOMContentLoaded', () => {
            fetchClientes();
          });
        </script>
</body>

</html>