<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cadastro de Cliente - Venda+</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="style.css"/>
</head>

<body>
<div id="dashboard-wrapper">
  <!-- SIDEBAR -->
  <div class="sidebar bg-dark" id="sidebar-wrapper">
    <div class="sidebar-heading text-center py-4">
      <a href="dashboard.html" class="text-decoration-none">
        <h1 class="logo-sidebar logo-full">VENDA<i>+</i></h1>
        <h1 class="logo-sidebar logo-compact">V<i>+</i></h1>
      </a>
    </div>
    <ul class="nav flex-column">
      <li class="nav-item"><a class="nav-link" href="dashboard.html"><i class="fas fa-chart-line"></i><span class="sidebar-text">Relatório de Vendas</span></a></li>
      <li class="nav-item"><a class="nav-link" href="registro-vendas.html"><i class="fas fa-cash-register"></i><span class="sidebar-text">Registro de Vendas</span></a></li>
      <li class="nav-item"><a class="nav-link active" href="cadastro-cliente.html"><i class="fas fa-user-plus"></i><span class="sidebar-text">Cadastro Clientes</span></a></li>
      <li class="nav-item"><a class="nav-link" href="cadastro-produto.html"><i class="fas fa-box-open"></i><span class="sidebar-text">Cadastro Produto</span></a></li>
      <li class="nav-item"><a class="nav-link" href="consulta.html"><i class="fas fa-search"></i><span class="sidebar-text">Consulta</span></a></li>
      <li class="nav-item"><a class="nav-link" href="inativos.html"><i class="fas fa-user-slash"></i><span class="sidebar-text">Inativos</span></a></li>
    </ul>
  </div>

  <!-- CONTEÚDO -->
  <div id="page-content-wrapper">
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
      <div class="container-fluid">
        <button class="btn btn-primary" id="menu-toggle"><i class="fas fa-bars"></i></button>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto mt-2 mt-lg-0">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                <i class="fas fa-user-circle me-2"></i>Usuário Admin
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="index.html">Sair</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container-fluid p-4">
      <h1 class="h3 mb-4">Formulário de Cadastro</h1>

      <!-- CARD: FORM -->
      <div class="card shadow-sm border-0">
        <div class="card-body p-4">
          <div id="feedbackMessage" class="mb-3"></div>

          <form id="clienteForm" novalidate>
            <div class="accordion custom-accordion" id="accordionCadastro">
              
              <!-- DADOS PESSOAIS -->
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePersonal" aria-expanded="true">
                    <i class="fas fa-user me-2"></i> Dados Pessoais
                  </button>
                </h2>
                <div id="collapsePersonal" class="accordion-collapse collapse show" data-bs-parent="#accordionCadastro">
                  <div class="accordion-body">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label for="clienteNome" class="form-label">Nome Completo</label>
                        <input type="text" class="form-control" id="clienteNome" placeholder="Digite o nome completo" required>
                        <div class="invalid-feedback">O nome é obrigatório.</div>
                      </div>
                      <div class="col-md-6">
                        <label for="clienteCpf" class="form-label">CPF</label>
                        <input type="text" class="form-control" id="clienteCpf" maxlength="11" placeholder="Somente números" required>
                        <div class="invalid-feedback">CPF deve conter 11 dígitos.</div>
                      </div>
                      <div class="col-md-6">
                        <label for="clienteNascimento" class="form-label">Data de Nascimento</label>
                        <input type="date" class="form-control" id="clienteNascimento" required>
                        <div class="invalid-feedback">Data de nascimento obrigatória.</div>
                      </div>
                      <div class="col-md-6">
                        <label for="clienteGenero" class="form-label">Sexo</label>
                        <select id="clienteGenero" class="form-select" required>
                          <option value="">Escolher...</option>
                          <option>Feminino</option>
                          <option>Masculino</option>
                        </select>
                        <div class="invalid-feedback">Selecione o sexo.</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ENDEREÇO -->
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAddress">
                    <i class="fas fa-map-marker-alt me-2"></i> Residência
                  </button>
                </h2>
                <div id="collapseAddress" class="accordion-collapse collapse" data-bs-parent="#accordionCadastro">
                  <div class="accordion-body">
                    <div class="row g-3">
                      <div class="col-md-3">
                        <label for="clienteCep" class="form-label">CEP</label>
                        <input type="text" class="form-control" id="clienteCep" maxlength="8" placeholder="00000000" required>
                        <div class="invalid-feedback">CEP deve conter 8 dígitos.</div>
                      </div>
                      <div class="col-md-7">
                        <label for="clienteEndereco" class="form-label">Endereço</label>
                        <input type="text" class="form-control" id="clienteEndereco" required>
                        <div class="invalid-feedback">Endereço obrigatório.</div>
                      </div>
                      <div class="col-md-2">
                        <label for="clienteNumero" class="form-label">Número</label>
                        <input type="text" class="form-control" id="clienteNumero" required>
                        <div class="invalid-feedback">Informe o número.</div>
                      </div>
                      <div class="col-md-5">
                        <label for="clienteBairro" class="form-label">Bairro</label>
                        <input type="text" class="form-control" id="clienteBairro" required>
                        <div class="invalid-feedback">Informe o bairro.</div>
                      </div>
                      <div class="col-md-4">
                        <label for="clienteCidade" class="form-label">Cidade</label>
                        <input type="text" class="form-control" id="clienteCidade" required>
                        <div class="invalid-feedback">Informe a cidade.</div>
                      </div>
                      <div class="col-md-3">
                        <label for="clienteEstado" class="form-label">Estado</label>
                        <input type="text" class="form-control" id="clienteEstado" maxlength="2" placeholder="Ex: SC" required>
                        <div class="invalid-feedback">Informe o estado (UF).</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- CONTATO -->
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseContact">
                    <i class="fas fa-phone me-2"></i> Telefone e E-mail
                  </button>
                </h2>
                <div id="collapseContact" class="accordion-collapse collapse" data-bs-parent="#accordionCadastro">
                  <div class="accordion-body">
                    <div class="row g-3">
                      <div class="col-md-4">
                        <label for="clienteTelefone1" class="form-label">Telefone 1</label>
                        <input type="text" class="form-control" id="clienteTelefone1" maxlength="11" required>
                        <div class="invalid-feedback">Telefone obrigatório (10 ou 11 dígitos).</div>
                      </div>
                      <div class="col-md-4">
                        <label for="clienteTelefone2" class="form-label">Telefone 2</label>
                        <input type="text" class="form-control" id="clienteTelefone2" maxlength="11" placeholder="(Opcional)">
                      </div>
                      <div class="col-md-4">
                        <label for="clienteEmail" class="form-label">E-mail</label>
                        <input type="email" class="form-control" id="clienteEmail" placeholder="exemplo@email.com" required>
                        <div class="invalid-feedback">Informe um e-mail válido.</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- OBSERVAÇÃO -->
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseObs">
                    <i class="fas fa-comment-alt me-2"></i> Observação
                  </button>
                </h2>
                <div id="collapseObs" class="accordion-collapse collapse" data-bs-parent="#accordionCadastro">
                  <div class="accordion-body">
                    <textarea class="form-control" id="clienteObservacao" rows="3" placeholder="Adicione notas sobre o cliente..."></textarea>
                  </div>
                </div>
              </div>
            </div>

            <div class="text-end mt-4">
              <button type="submit" id="submitBtn" class="btn btn-primary px-4 btn-lg">Cadastrar Cliente</button>
            </div>
          </form>
        </div>
      </div>

      <!-- LISTA DE CLIENTES -->
      <div class="card shadow-sm border-0 mt-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h6 class="m-0 font-weight-bold text-dark">Lista de Clientes</h6>

          <div class="input-group" style="max-width: 300px;">
            <input type="text" id="pesquisarInput" class="form-control" placeholder="Pesquisar clientes...">
            <button class="btn btn-outline-secondary" id="pesquisarBtn" type="button" title="Pesquisar">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>

        <div class="card-body">
          <div class="table-responsive">
            <table class="table client-list-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nome</th>
                  <th>Data de Nascimento</th>
                  <th>Telefone</th>
                  <th>E-mail</th>
                  <th class="text-center">Ações</th>
                </tr>
              </thead>
              <tbody id="listaClientesBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const wrapper = document.getElementById('dashboard-wrapper');
document.getElementById('menu-toggle').addEventListener('click', () => wrapper.classList.toggle('collapsed'));

let clientesCache = [];
let clienteEditando = null;
const feedbackMessage = document.getElementById('feedbackMessage');

// ======== VALIDAÇÃO =========
function validarCampos() {
  let valido = true;
  document.querySelectorAll('#clienteForm [required]').forEach(el => {
    if (!el.value.trim()) {
      el.classList.add('is-invalid');
      valido = false;
    } else {
      el.classList.remove('is-invalid');
      el.classList.add('is-valid');
    }
  });
  const cpf = document.getElementById('clienteCpf');
  if (cpf.value.length !== 11) { cpf.classList.add('is-invalid'); valido = false; }
  const tel1 = document.getElementById('clienteTelefone1');
  if (tel1.value.length < 10 || tel1.value.length > 11) { tel1.classList.add('is-invalid'); valido = false; }
  const email = document.getElementById('clienteEmail');
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value)) { email.classList.add('is-invalid'); valido = false; }
  return valido;
}

// ======== LISTAGEM =========
async function carregarClientes() {
  const tbody = document.getElementById('listaClientesBody');
  tbody.innerHTML = '<tr><td colspan="6">Carregando...</td></tr>';
  try {
    const resp = await fetch('http://localhost:3000/api/clientes');
    const data = await resp.json();
    clientesCache = Array.isArray(data) ? data : [];
    renderTabela(clientesCache);
  } catch {
    tbody.innerHTML = '<tr><td colspan="6" class="text-danger text-center">Erro ao carregar clientes.</td></tr>';
  }
}

function renderTabela(lista) {
  const tbody = document.getElementById('listaClientesBody');
  tbody.innerHTML = '';
  if (!lista.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum cliente cadastrado.</td></tr>';
    return;
  }
  lista.forEach(c => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${c.idCliente}</td>
      <td>${c.nome}</td>
      <td>${c.dataNascimento || ''}</td>
      <td>${c.telefone1 || ''}</td>
      <td>${c.email || ''}</td>
      <td class="text-center">
        <button class="btn btn-sm btn-outline-primary me-2" onclick="editarCliente(${c.idCliente})" title="Editar">
          <i class="fas fa-pencil-alt"></i>
        </button>
        <button class="btn btn-sm btn-outline-danger" onclick="inativarCliente(${c.idCliente})" title="Inativar">
          <i class="fas fa-user-slash"></i>
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ======== EDITAR CLIENTE =========
async function editarCliente(id) {
  try {
    const resp = await fetch(`http://localhost:3000/api/clientes/${id}`);
    const c = await resp.json();
    Object.entries(c).forEach(([k, v]) => {
      const el = document.getElementById('cliente' + k.charAt(0).toUpperCase() + k.slice(1));
      if (el) el.value = v || '';
    });
    clienteEditando = id;
    const btn = document.getElementById('submitBtn');
    btn.textContent = 'Salvar Alterações';
    btn.classList.replace('btn-primary', 'btn-warning');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  } catch {
    alert('Erro ao buscar cliente.');
  }
}

// ======== CADASTRAR / EDITAR CLIENTE =========
const form = document.getElementById('clienteForm');
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!validarCampos()) return;

  const dados = Object.fromEntries(new FormData(form).entries());
  const url = clienteEditando
    ? `http://localhost:3000/api/clientes/${clienteEditando}`
    : 'http://localhost:3000/api/clientes';
  const method = clienteEditando ? 'PUT' : 'POST';

  try {
    const resp = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(dados)
    });
    const result = await resp.json();

    if (resp.ok) {
      feedbackMessage.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
      setTimeout(() => feedbackMessage.innerHTML = '', 5000);
      form.reset();
      clienteEditando = null;
      const btn = document.getElementById('submitBtn');
      btn.textContent = 'Cadastrar Cliente';
      btn.classList.replace('btn-warning', 'btn-primary');
      carregarClientes();
      document.querySelectorAll('.is-valid, .is-invalid').forEach(el => el.classList.remove('is-valid', 'is-invalid'));
    } else {
      feedbackMessage.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
    }
  } catch {
    feedbackMessage.innerHTML = `<div class="alert alert-danger">Erro ao conectar com o servidor.</div>`;
  }
});

// ======== INATIVAR CLIENTE =========
async function inativarCliente(id) {
  if (!confirm('Deseja realmente inativar este cliente?')) return;
  try {
    const resp = await fetch(`http://localhost:3000/api/clientes/${id}/inativar`, { method: 'PATCH' });
    const result = await resp.json();
    alert(result.message);
    carregarClientes();
  } catch {
    alert('Erro ao inativar cliente.');
  }
}

// ======== PESQUISA =========
document.getElementById('pesquisarInput').addEventListener('input', (e) => {
  const termo = e.target.value.toLowerCase();
  const filtrados = clientesCache.filter(c =>
    c.nome.toLowerCase().includes(termo) ||
    c.email.toLowerCase().includes(termo) ||
    (c.telefone1 && c.telefone1.includes(termo))
  );
  renderTabela(filtrados);
});

document.addEventListener('DOMContentLoaded', carregarClientes);
</script>
</body>
</html>
